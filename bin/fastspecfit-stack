#!/usr/bin/env python
"""fastspecfit QA

fastspecfit-stack --tile 80608 /global/cfs/cdirs/desi/users/ioannis/fastspecfit/daily/tiles/specfit-80607-80613-20201215-20201223.fits

"""
import pdb # for debugging
import os, sys, time
import numpy as np

from desiutil.log import get_logger
log = get_logger()

# ridiculousness!
import tempfile
os.environ['MPLCONFIGDIR'] = tempfile.mkdtemp()

import multiprocessing

def _desiqa_one(args):
    """Multiprocessing wrapper."""
    return desiqa_one(*args)

def desiqa_one(indx, data, specfit, photfit, CFit, EMFit, qadir):
    """QA on one spectrum."""
    t0 = time.time()
    continuum = CFit.qa_continuum(data, specfit, photfit, qadir)
    EMFit.qa_emlines(data, specfit, continuum, qadir)
    log.info('Building QA for object {} took {:.2f} sec'.format(indx, time.time()-t0))

def parse(options=None):
    """Parse input arguments.

    """
    import argparse

    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)

    parser.add_argument('--photfit', action='store_true', help='Fit and write out just the broadband photometry.')

    parser.add_argument('--suffix', default=None, type=str, help='Optional suffix for output filename.')
    parser.add_argument('--tile', default=None, type=str, help='Generate QA for all objects on this tile.')
    parser.add_argument('--night', default=None, type=str, help='Generate QA for all objects observed on this night.')
    parser.add_argument('--targetids', type=str, default=None, help='Comma-separated list of target IDs to process.')
    parser.add_argument('-n', '--ntargets', type=int, help='Number of targets to process in each file.')
    parser.add_argument('--firsttarget', type=int, default=0, help='Index of first object to to process in each file (0-indexed).')
    parser.add_argument('--mp', type=int, default=1, help='Number of multiprocessing processes per MPI rank or node.')

    parser.add_argument('fastspecfitfile', type=str, help='Full path to results FITS file written by fastspecfit.')

    if options is None:
        args = parser.parse_args()
        log.info(' '.join(sys.argv))
    else:
        args = parser.parse_args(options)
        log.info('fastspecfit_qa {}'.format(' '.join(options)))

    return args

def main(args=None, comm=None):
    """Main module.

    """
    import fitsio
    from astropy.table import Table
    from fastspecfit.continuum import ContinuumFit
    from fastspecfit.emlines import EMLineFit
    from fastspecfit.external.desi import DESISpectra
    from desispec.interpolation import resample_flux

    if isinstance(args, (list, tuple, type(None))):
        args = parse(args)

    # Read the fitting results.
    if not os.path.isfile(args.fastspecfitfile):
        log.info('Required FITS file (from fastspecfit) {} not found!'.format(args.fastspecfitfile))
        return
    fastfit = Table(fitsio.read(args.fastspecfitfile))
    log.info('Read {} objects from {}'.format(len(fastfit), args.fastspecfitfile))

    if args.tile or args.night:
        keep = np.ones(len(fastfit), bool)
        if args.tile:
            keep *= (fastfit['TILEID'].astype(str) == args.tile)
        if args.night:
            keep *= (fastfit['NIGHT'].astype(str) == args.night)
        fastfit = fastfit[keep]
        log.info('Keeping {} spectra from tile {} on night {}.'.format(len(fastfit), args.tile, args.night))

    if args.targetids:
        targetids = [int(x) for x in args.targetids.split(',')]
    else:
        targetids = fastfit['TARGETID'].data

    if False:
        these = np.where([tid in targetids for tid in fastfit['TARGETID']])[0]
        if len(these) == 0:
            log.info('All done!')
            return

    # Initialize the continuum- and emission-line fitting classes.
    CFit = ContinuumFit()
    EMFit = EMLineFit()
    Spec = DESISpectra()

    # Get the spectra.
    log.info('Need to get specprod from the header!')
    specprod = 'daily'
    specprod_dir = os.path.join(os.getenv('DESI_ROOT'), 'spectro', 'redux', specprod, 'tiles')    

    #cut = np.where(
    #    (fastfit['OII_3726_FLUX'] > 0) *
    #    (fastfit['OII_3729_FLUX'] > 0) *
    #    (fastfit['OII_3726_AMP']*np.sqrt(fastfit['OII_3726_AMP_IVAR']) > 1) *
    #    (fastfit['OII_3729_AMP']*np.sqrt(fastfit['OII_3729_AMP_IVAR']) > 1))[0]
    #cut = cut[:3]
    #fastfit = fastfit[cut]
    
    ielg = np.where((fastfit['OII_3726_AMP']*np.sqrt(fastfit['OII_3726_AMP_IVAR']) > 2) *
                    (fastfit['OII_3729_AMP']*np.sqrt(fastfit['OII_3729_AMP_IVAR']) > 2))[0]
    fastfit = fastfit[ielg]

    Spec.find_specfiles(fastfit=fastfit, specprod_dir=specprod_dir, targetids=targetids,
                        firsttarget=args.firsttarget, ntargets=args.ntargets)
    if len(Spec.specfiles) == 0:
        return
    data = Spec.read_and_unpack(CFit, synthphot=False, remember_coadd=True)
    ngal = len(data)
    
    restwave = np.arange(1500.0, 8000.0, 0.5)
    npix = len(restwave)
    restflux = np.zeros((ngal, npix))

    redshift = []
    for igal, onegal in enumerate(data):
        zz = onegal['zredrock']
        restflux[igal, :] = resample_flux(restwave, onegal['coadd_wave'] / (1+zz),
                                          onegal['coadd_flux'], extrapolate=False)
        redshift.append(zz)
    redshift = np.hstack(redshift)

    zsrt = np.argsort(redshift)
    redshift = redshift[zsrt]
    restflux = restflux[zsrt, :]

    import matplotlib.pyplot as plt
    plt.clf() ; plt.plot(restwave, np.sum(restflux, axis=0)) ; plt.savefig('elgs.png')    
    #plt.clf() ; plt.plot(restwave, np.sum(restflux, axis=0)) ; plt.xlim(4600, 5100) ; plt.savefig('elgs.png')    

    pdb.set_trace()

if __name__ == '__main__':
    main()
    

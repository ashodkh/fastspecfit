#! /bin/bash

# Shell script for running mpi-fastspecfit with MPI+shifter at NERSC. Required arguments:
#   {1} stage [fastspec, fastphot, test]
#   {2} mp [should match the resources requested.]

# Example: build the coadds using 16 MPI tasks with 8 cores per node (and therefore 16*8/32=4 nodes)

# Perlmutter
#salloc -N 4 -C cpu -A desi -L cfs -t 04:00:00 --qos interactive --image=docker:desihub/fastspecfit:v1.0.0
#srun -n 4 -c 128 --kill-on-bad-exit=0 --no-kill shifter --module=mpich /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh fastspec fuji 128 healpix sv1 > /global/cfs/cdirs/desi/spectro/fastspecfit/fuji/logs/fastspec-fuji-sv1.log.1 2>&1 &

#srun -n 16 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh fastspec 32 sv2 dark > /global/cfs/cdirs/desi/spectro/fastspecfit/fuji/logs/fastspec-fuji-sv2-dark.log.1 2>&1 &
#srun -n 16 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh fastphot 32 sv2 dark > /global/cfs/cdirs/desi/spectro/fastspecfit/fuji/logs/fastphot-fuji-sv2-dark.log.1 2>&1 &
#srun -n 16 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh qafastspec 32 > qafastspec-fuji.log.1 2>&1 &
#srun -n 16 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh qafastphot 32 > qafastphot-fuji.log.1 2>&1 &

# Cori
#salloc -N 32 -C haswell -A desi -L cfs -t 04:00:00 --qos interactive --image=docker:desihub/fastspecfit:v1.0.0
#srun -n 32 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh fastspec fuji 32 healpix sv2,sv3 > /global/cfs/cdirs/desi/spectro/fastspecfit/fuji/logs/fastspec-fuji-sv2sv3.log.1 2>&1 &

#srun -n 16 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich-cle6 /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh fastspec fuji 32 - sv1 > /global/cfs/cdirs/desi/spectro/fastspecfit/fuji/logs/fastspec-fuji-sv1.log.1 2>&1 &
#srun -n 16 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich-cle6 /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh fastphot 32 sv2 dark > /global/cfs/cdirs/desi/spectro/fastspecfit/fuji/logs/fastphot-fuji-sv2-dark.log.1 2>&1 &
#srun -n 16 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich-cle6 /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh qafastspec 32 > qafastspec-fuji.log.1 2>&1 &
#srun -n 16 -c 32 --kill-on-bad-exit=0 --no-kill shifter --module=mpich-cle6 /global/homes/i/ioannis/code/desihub/fastspecfit/bin/mpi-fastspecfit.sh qafastphot 32 > qafastphot-fuji.log.1 2>&1 &

codedir=/global/homes/i/ioannis/code/desihub
#codedir=/usr/local/bin
mpiscript=$codedir/fastspecfit/bin/mpi-fastspecfit

for package in fastspecfit; do
    echo Loading local check-out of $package
    export PATH=$codedir/$package/bin:$PATH
    export PYTHONPATH=$codedir/$package/py:$PYTHONPATH
done

outdir_data=/global/cfs/cdirs/desi/spectro/fastspecfit
outdir_html=/global/cfs/cdirs/desi/users/ioannis/fastspecfit

export DESI_ROOT='/global/cfs/cdirs/desi'
export DUST_DIR='/global/cfs/cdirs/cosmo/data/dust/v0_1'
export FASTSPECFIT_TEMPLATES='/global/cfs/cdirs/desi/science/gqp/templates/SSP-CKC14z'

export TMPCACHE=$(mktemp -d)
export MPLCONFIGDIR=$TMPCACHE/matplotlib
mkdir $MPLCONFIGDIR
cp -r $HOME/.config/matplotlib $MPLCONFIGDIR

export OMP_NUM_THREADS=1
export MKL_NUM_THREADS=1
export KMP_AFFINITY=disabled
export MPICH_GNI_FORK_MODE=FULLCOPY

stage=$1
specprod=$2
mp=$3
coadd_type=$4
survey=$5
program=$6

#echo stage=$stage
#echo specprod=$specprod
#echo mp=$mp
#echo coadd_type=$coadd_type
#echo survey=$survey
#echo program=$program

args="--outdir-data $outdir_data --outdir-html $outdir_html"

if [[ $stage == "fastphot" ]]; then
    args=$args" --fastphot"
fi
if [[ $specprod != " " ]] && [[ $specprod != "-" ]]; then
    args=$args" --specprod $specprod"
fi
if [[ $mp != " " ]] && [[ $mp != "-" ]]; then
    args=$args" --mp $mp"
fi
if [[ $coadd_type != " " ]] && [[ $coadd_type != "-" ]]; then
    args=$args" --coadd-type $coadd_type"
else
    args=$args" --coadd-type healpix"
fi
if [[ $survey != " " ]] && [[ $survey != "-" ]]; then
    args=$args" --survey $survey"
fi
if [[ ! -z $program ]] && [[ $program != "-" ]]; then
    args=$args" --program $program"
fi

echo python $mpiscript $args --overwrite --healpix 8203,8204,8206,8207,8209,8210,8211,8212,8214,8221,8233,8238,8239,8240,8248,8249,8253,8259,8260,8261,8265,8266,8270,8272,8273,8277,8282,8290,8293,8296,8301,8305,8306,8309,8311,8313,8314,8319,8321,8323,8325,8326,8327,8328,8329,8330,8338,8340,8342,8348,8352,8353,8370,8371,8377,8379,8381,8383,8388,8391,8396,8399,8409,8412,8413,8422,8423,8434,8439,8449,8452,8453,8460,8469,8472,8480,8482,8487,8491,8495,8496,8500,8501,8502,8503,8506,8508,8510,8512,8519,8523,8525,8527,8528,8535,8537,8540,8541,8544,8553,8554,8556,8558,8563,8566,8569,8572,8578,8579,8585,8589,8594,8600,8601,8608,8610,8613,8615,8622,8624,8627,8628,8629,8631,8642,8648,8649,8658,8661,8664,8675,8676,8678,8679,8682,8692,8698,8700,8702,8724,8961,8964,8966,8977,8980,8981,8987,8991,9009,9011,9017,9019,9020,9022,9025,9031,9036,9037,9039,9040,9052,9054,9055,9065,9071,9080,9081,9087,9110,9111,9117,9119,9127,9135,9137,9139,9143,9150,9152,9158,9159,9170,9172,9174,9175,9183,9184,9187,9190,9197,9198,9200,9205,9206,9209,9211,9214,9217,9222,9228,9233,9235,9236,9240,9241,9242,9243,9249,9251,9264,9265,9272,9278,9279,9283,9287,9290,9293,9299,9301,9304,9306,9311,9318,9319,9320,9324,9325,9329,9330,9332,9336,9338,9339,9345,9346,9349,9358,9364,9365,9369,9372,9374,9375,9378,9380,9382,9383,9384,9385,9386,9389,9399,9400,9411,9412,9423,9424,9425,9427,9431,9432,9436,9437,9438,9441,9445,9447,9450,9451,9452,9462,9465,9467,9479,9483,9490,9491,9501,9503,9510,9511,9512,9514,9520,9522,9524,9526,9527,9532,9534,9536,9540,9541,9543,9545,9546,9553,9563,9564,9566,9567,9574,9585,9590,9592,9604,9606,9618,9626,9627,9628,9629,9634,9635,9645,9646,9656,9657,9663,9665,9666,9668,9669,9670,9681,9695,9697,9698,9699,9704,9705,9712,9713,9723,9732,9740,9744,9745,9747,9750,9755,9759,9762,9773,9778,9787,9790,9792,9793,9796,9802,9805,9806,9808,9811,9813,9815,9816,9824,9825,9833,9836,9840,9841,9843,9856,9860,9863,9865,9866,9871,9879,9882,9885,9888,9897,9899,9920,9925,9926,9927,9949,9951,9988,9997,9999,10002,10006,10012,10027,10034,10037,10038,10039,10040,10059,10064,10065,10067,10078,10086,10091,10097,10102,10104,10111,10124,10131,10135,10176,10178,10181,10183,10193,10195,10196,10201,10203,10209,10210,10211,10399,10422,10426,10427,10428,10430,10439,10442,10454,10455,10461,10464,10465,10489,10500,10501,10513,10516,10517,10522,10525,10527,10529,10535,10537,10539,10546,10552,10553,10561,10564,10570,10576,10581,10582,10587,10588,10589,10629,10630,10632,10636,10767,10786,10788,10806,10808,10810,10812,10821,10832,11118,11123,11128,11129,11599,11602,11621,12289,12296,12306,12308,12312,12314,12319,12326,12328,12332,12341,12342,12345,12348,12355,12358,12360,12384,12598,12604,12606,12656,12657,12659,12660,12669,13344,13346,13347,13351,13357,13362,13363,13367,13373,13410,13411,13415,13420,14986,14991,15008,15014,15015,15022,15023,15029,15030,15031,15039,15066,15070,15075,15077,15080,15082,15085,15087,15088,15095,15101,15102,15103,15234,15235,15240,15241,15256,15259,15266,15274,15278,15281,15282,15288,15289,15294,15307,15334,15335,18685,18827,18830,18842,18849,18852,18853,18854,18855,18856,18857,18860,18866,18977,18979,18982,18983,18985,19000,19001,19050,19067,19070,19071,19076,19078,19080,19090,19094,19097,19098,19099,19100,19104,19105,19110,19117,19118,19122,19123,19127,19134,19142,19148,19150,19168,19170,19182,19204,19330,25468,25470,25471,25552,25557,25717,25724,25727,25757,25786,25792,25794,25800,25801,25811,25812,25818,25845,25862,25864,25866,25870,25879,25881,25886,25890,25895,25896,25901,25902,25904,25908,25912,25917,25918,25919,25920,25922,25927,25932,25938,25943,25947,25949,25953,25956,25959,25962,25965,25967,25968,25969,25970,25971,25973,25981,25988,25990,25992,25994,26003,26008,26009,26012,26016,26020,26021,26022,26032,26034,26037,26039,26043,26044,26049,26053,26054,26057,26067,26068,26069,26072,26073,26074,26075,26080,26081,26085,26086,26087,26089,26093,26101,26108,26111,26117,26128,26129,26188,26190,26209,26212,26384,26385,28535,28541,28543,30021,30032,30034,30043,30044,30045,30053,30064,30065,30067,30068,30070,30072,30076,31143,31145,31147,31155,31160,31161,31162,31163,31165,31166,31213,31214,31215,31226,31227,31326,31334,31337,31342,31349,31368,31375,31383,31385,31386,31388,31390,31392,31403,31408,31410,31414,31416,31422,31427,31433,31435,31436,31438,31442,31443,31444,31446,31451,31463,31464,31466,31467,31469,31471,31473,31475,31480,31487,31488,31489,31492,31498,31508,31509,31511,31512,31514,31519,31520,31521,31522,31530,31533,31535,31545,31546,31547,31550,31551,31552,31553,31555,31558,31562,31565,31567,31568,31569,31570,31574,31580,31581,31584,31589,31590,31594,31596,31597,31602,31604,31606,31611,31625,31628,31629,31636,31637,31644,31645,31648,31650,31651,31655,31660,31662,31663,31665,31666,31667,31680,31686,31692,31694,31698,31699,31702,31707,31711,31712,31715,31728,31729,31737,31738,31743,31935,31978,31979,32258,32260,32262,32280,32282,32283,32284,32285,32286,32287,32289,32292,32301,32303,32307,32309,32312,32314,32321,32322,32324,32326,32327,32328,32329,32330,32331,32332,32333,32334,32335,32344,32346,32350,32351,32352,32353,32354,32355,32357,32364,32366,32374,32378,32382,32384,32385,32386,32391,32392,32393,32394,32396,32397,32405,32406,32407,32408,32413,32414,32415,32418,32419,32423,32424,32426,32429,32435,32436,32438,32446,32447,32448,32449,32452,32453,32458,32462,32473,32480,32481,32484,32491,32497,32498,32504,32505,32509,32523,32547,32568,32570,32643,32644,32655,32656,32664,32665,32666,32669,32672,32674,32676,32679,32683,32684,32686,32693,32694,32696,32702,32708,32709,32715,32716,32717,32720,32721,32722,32723,32724,32726,32729,32737,32740,32745,32746,32747,32753,32754,32757,32760,32766,32767,45018,45021,45023,45027,45032,45033,45034,45036,45038,45039,45045,45046,45049,45051,45054,45055,49046,49052,49054,49086,49087,49094,49095,49100,49101,49113,49115,49121,49124,49129,49130,49143,49146,49150,49151
time python $mpiscript $args --overwrite --healpix 8203,8204,8206,8207,8209,8210,8211,8212,8214,8221,8233,8238,8239,8240,8248,8249,8253,8259,8260,8261,8265,8266,8270,8272,8273,8277,8282,8290,8293,8296,8301,8305,8306,8309,8311,8313,8314,8319,8321,8323,8325,8326,8327,8328,8329,8330,8338,8340,8342,8348,8352,8353,8370,8371,8377,8379,8381,8383,8388,8391,8396,8399,8409,8412,8413,8422,8423,8434,8439,8449,8452,8453,8460,8469,8472,8480,8482,8487,8491,8495,8496,8500,8501,8502,8503,8506,8508,8510,8512,8519,8523,8525,8527,8528,8535,8537,8540,8541,8544,8553,8554,8556,8558,8563,8566,8569,8572,8578,8579,8585,8589,8594,8600,8601,8608,8610,8613,8615,8622,8624,8627,8628,8629,8631,8642,8648,8649,8658,8661,8664,8675,8676,8678,8679,8682,8692,8698,8700,8702,8724,8961,8964,8966,8977,8980,8981,8987,8991,9009,9011,9017,9019,9020,9022,9025,9031,9036,9037,9039,9040,9052,9054,9055,9065,9071,9080,9081,9087,9110,9111,9117,9119,9127,9135,9137,9139,9143,9150,9152,9158,9159,9170,9172,9174,9175,9183,9184,9187,9190,9197,9198,9200,9205,9206,9209,9211,9214,9217,9222,9228,9233,9235,9236,9240,9241,9242,9243,9249,9251,9264,9265,9272,9278,9279,9283,9287,9290,9293,9299,9301,9304,9306,9311,9318,9319,9320,9324,9325,9329,9330,9332,9336,9338,9339,9345,9346,9349,9358,9364,9365,9369,9372,9374,9375,9378,9380,9382,9383,9384,9385,9386,9389,9399,9400,9411,9412,9423,9424,9425,9427,9431,9432,9436,9437,9438,9441,9445,9447,9450,9451,9452,9462,9465,9467,9479,9483,9490,9491,9501,9503,9510,9511,9512,9514,9520,9522,9524,9526,9527,9532,9534,9536,9540,9541,9543,9545,9546,9553,9563,9564,9566,9567,9574,9585,9590,9592,9604,9606,9618,9626,9627,9628,9629,9634,9635,9645,9646,9656,9657,9663,9665,9666,9668,9669,9670,9681,9695,9697,9698,9699,9704,9705,9712,9713,9723,9732,9740,9744,9745,9747,9750,9755,9759,9762,9773,9778,9787,9790,9792,9793,9796,9802,9805,9806,9808,9811,9813,9815,9816,9824,9825,9833,9836,9840,9841,9843,9856,9860,9863,9865,9866,9871,9879,9882,9885,9888,9897,9899,9920,9925,9926,9927,9949,9951,9988,9997,9999,10002,10006,10012,10027,10034,10037,10038,10039,10040,10059,10064,10065,10067,10078,10086,10091,10097,10102,10104,10111,10124,10131,10135,10176,10178,10181,10183,10193,10195,10196,10201,10203,10209,10210,10211,10399,10422,10426,10427,10428,10430,10439,10442,10454,10455,10461,10464,10465,10489,10500,10501,10513,10516,10517,10522,10525,10527,10529,10535,10537,10539,10546,10552,10553,10561,10564,10570,10576,10581,10582,10587,10588,10589,10629,10630,10632,10636,10767,10786,10788,10806,10808,10810,10812,10821,10832,11118,11123,11128,11129,11599,11602,11621,12289,12296,12306,12308,12312,12314,12319,12326,12328,12332,12341,12342,12345,12348,12355,12358,12360,12384,12598,12604,12606,12656,12657,12659,12660,12669,13344,13346,13347,13351,13357,13362,13363,13367,13373,13410,13411,13415,13420,14986,14991,15008,15014,15015,15022,15023,15029,15030,15031,15039,15066,15070,15075,15077,15080,15082,15085,15087,15088,15095,15101,15102,15103,15234,15235,15240,15241,15256,15259,15266,15274,15278,15281,15282,15288,15289,15294,15307,15334,15335,18685,18827,18830,18842,18849,18852,18853,18854,18855,18856,18857,18860,18866,18977,18979,18982,18983,18985,19000,19001,19050,19067,19070,19071,19076,19078,19080,19090,19094,19097,19098,19099,19100,19104,19105,19110,19117,19118,19122,19123,19127,19134,19142,19148,19150,19168,19170,19182,19204,19330,25468,25470,25471,25552,25557,25717,25724,25727,25757,25786,25792,25794,25800,25801,25811,25812,25818,25845,25862,25864,25866,25870,25879,25881,25886,25890,25895,25896,25901,25902,25904,25908,25912,25917,25918,25919,25920,25922,25927,25932,25938,25943,25947,25949,25953,25956,25959,25962,25965,25967,25968,25969,25970,25971,25973,25981,25988,25990,25992,25994,26003,26008,26009,26012,26016,26020,26021,26022,26032,26034,26037,26039,26043,26044,26049,26053,26054,26057,26067,26068,26069,26072,26073,26074,26075,26080,26081,26085,26086,26087,26089,26093,26101,26108,26111,26117,26128,26129,26188,26190,26209,26212,26384,26385,28535,28541,28543,30021,30032,30034,30043,30044,30045,30053,30064,30065,30067,30068,30070,30072,30076,31143,31145,31147,31155,31160,31161,31162,31163,31165,31166,31213,31214,31215,31226,31227,31326,31334,31337,31342,31349,31368,31375,31383,31385,31386,31388,31390,31392,31403,31408,31410,31414,31416,31422,31427,31433,31435,31436,31438,31442,31443,31444,31446,31451,31463,31464,31466,31467,31469,31471,31473,31475,31480,31487,31488,31489,31492,31498,31508,31509,31511,31512,31514,31519,31520,31521,31522,31530,31533,31535,31545,31546,31547,31550,31551,31552,31553,31555,31558,31562,31565,31567,31568,31569,31570,31574,31580,31581,31584,31589,31590,31594,31596,31597,31602,31604,31606,31611,31625,31628,31629,31636,31637,31644,31645,31648,31650,31651,31655,31660,31662,31663,31665,31666,31667,31680,31686,31692,31694,31698,31699,31702,31707,31711,31712,31715,31728,31729,31737,31738,31743,31935,31978,31979,32258,32260,32262,32280,32282,32283,32284,32285,32286,32287,32289,32292,32301,32303,32307,32309,32312,32314,32321,32322,32324,32326,32327,32328,32329,32330,32331,32332,32333,32334,32335,32344,32346,32350,32351,32352,32353,32354,32355,32357,32364,32366,32374,32378,32382,32384,32385,32386,32391,32392,32393,32394,32396,32397,32405,32406,32407,32408,32413,32414,32415,32418,32419,32423,32424,32426,32429,32435,32436,32438,32446,32447,32448,32449,32452,32453,32458,32462,32473,32480,32481,32484,32491,32497,32498,32504,32505,32509,32523,32547,32568,32570,32643,32644,32655,32656,32664,32665,32666,32669,32672,32674,32676,32679,32683,32684,32686,32693,32694,32696,32702,32708,32709,32715,32716,32717,32720,32721,32722,32723,32724,32726,32729,32737,32740,32745,32746,32747,32753,32754,32757,32760,32766,32767,45018,45021,45023,45027,45032,45033,45034,45036,45038,45039,45045,45046,45049,45051,45054,45055,49046,49052,49054,49086,49087,49094,49095,49100,49101,49113,49115,49121,49124,49129,49130,49143,49146,49150,49151
